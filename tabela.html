<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Frequência Bolsistas</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; background-color:#f4f4f4; }
h2 { margin-bottom:10px; color:#333; }
table { border-collapse: collapse; width: 100%; display:block; overflow-x:auto; white-space: nowrap; background:#fff; }
th, td { border:1px solid #ccc; padding:8px; text-align:center; }
th { background-color:#f2f2f2; position:sticky; top:0; }
input[type="text"] { width:120px; }
input[type="file"] { width:120px; }
button { padding:5px 8px; margin:5px; cursor:pointer; border-radius:4px; border:none; background-color:#4CAF50; color:white; }
button:hover { background-color:#45a049; }
.vermelho { background-color:#f8d7da; }
input.justificativa, input.atestado { display:none; width:120px; }
#botoesControle { margin-bottom:10px; }
</style>
</head>
<body>

<h2>Tabela de Frequência - Coordenador: <span id="nomeCoordenador"></span></h2>

<div id="botoesControle">
    <button onclick="adicionarBolsista()">Adicionar Bolsista</button>
</div>

<table id="tabelaFrequencia">
<thead>
<tr>
    <th>Bolsista</th>
    <th>Jan</th><th>Fev</th><th>Mar</th><th>Abr</th><th>Mai</th><th>Jun</th>
    <th>Jul</th><th>Ago</th><th>Set</th><th>Out</th><th>Nov</th><th>Dez</th>
    <th>Justificativa</th>
    <th>Atestado</th>
    <th>Remover</th>
    <th id="thResponsavel" style="display:none;">Responsável</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>
window.onload = function(){
    const adminEmail = "bolsatrabalho@prex.uespi.br";
    let coordenador = sessionStorage.getItem("coordenadorLogado") || "desconhecido@uespi.br";
    coordenador = coordenador.toLowerCase();
    document.getElementById("nomeCoordenador").innerText = coordenador;
    console.log("Coordenador logado:", coordenador);

    let dados = [];

    // Admin vê todos
    if(coordenador === adminEmail){
        document.getElementById("thResponsavel").style.display = "table-cell";
        for(let i=0;i<localStorage.length;i++){
            const chave = localStorage.key(i);
            if(chave !== "coordenadorLogado"){
                const coordDados = JSON.parse(localStorage.getItem(chave)) || [];
                coordDados.forEach(bolsista=>{
                    bolsista._responsavel = chave;
                    dados.push(bolsista);
                });
            }
        }
    } else {
        dados = JSON.parse(localStorage.getItem(coordenador)) || [];
    }

    const tbody = document.querySelector("#tabelaFrequencia tbody");

    function renderTabela(){
        tbody.innerHTML = "";
        dados.forEach((b, i)=>{
            const tr = document.createElement("tr");

            // Nome
            const tdNome = document.createElement("td");
            tdNome.innerHTML = `<input type="text" value="${b.nome}" onchange="atualizarNome(${i}, this.value)">`;
            tr.appendChild(tdNome);

            // Meses
            for(let m=0;m<12;m++){
                const tdMes = document.createElement("td");
                const checkbox = document.createElement("input");
                checkbox.type="checkbox";
                checkbox.checked = b.meses[m];
                checkbox.onchange = ()=>atualizarMes(i,m,checkbox.checked,tdMes);
                tdMes.appendChild(checkbox);
                tdMes.classList.toggle("vermelho", !checkbox.checked);
                tr.appendChild(tdMes);
            }

            // Justificativa
            const tdJust = document.createElement("td");
            tdJust.innerHTML = `<input class="justificativa" type="text" value="${b.justificativa||''}" onchange="atualizarJust(${i},this.value)">`;
            tr.appendChild(tdJust);

            // Atestado
            const tdAtestado = document.createElement("td");
            tdAtestado.innerHTML = `<input class="atestado" type="file" onchange="atualizarAtestado(${i},this.files)">`;
            tr.appendChild(tdAtestado);

            // Remover
            const tdRemover = document.createElement("td");
            const btnRemover = document.createElement("button");
            btnRemover.innerText = "Remover";
            btnRemover.onclick = ()=>removerBolsista(i);
            tdRemover.appendChild(btnRemover);
            tr.appendChild(tdRemover);

            // Responsável
            if(coordenador === adminEmail){
                const tdResp = document.createElement("td");
                tdResp.innerText = b._responsavel||"";
                tr.appendChild(tdResp);
            }

            tbody.appendChild(tr);
        });

        atualizarCamposJustAtestadoTodos();
        salvar();
    }

    // Funções auxiliares
    window.atualizarNome = function(i, v){ dados[i].nome=v; salvar(); }
    window.atualizarMes = function(i,m,v,td){
        dados[i].meses[m]=v;
        td.classList.toggle("vermelho", !v);
        atualizarCamposJustAtestado(i);
        salvar();
    }
    window.atualizarJust = function(i,v){ dados[i].justificativa=v; salvar(); }
    window.atualizarAtestado = function(i,files){
        dados[i].atestado = files.length>0 ? files[0].name : "";
        salvar();
    }

    function atualizarCamposJustAtestado(i){
        const tr = tbody.querySelectorAll("tr")[i];
        const falta = dados[i].meses.some(m=>!m);
        tr.querySelector("input.justificativa").style.display = falta ? "inline-block" : "none";
        tr.querySelector("input.atestado").style.display = falta ? "inline-block" : "none";
    }
    function atualizarCamposJustAtestadoTodos(){
        dados.forEach((_,i)=>atualizarCamposJustAtestado(i));
    }

    window.adicionarBolsista = function(){
        dados.push({nome:"",meses:Array(12).fill(false),justificativa:"",atestado:""});
        renderTabela();
    }
    function removerBolsista(i){
        if(confirm("Remover este bolsista?")){
            dados.splice(i,1);
            renderTabela();
        }
    }

    function salvar(){
        if(coordenador===adminEmail){
            let mapa={};
            dados.forEach(b=>{
                const resp=b._responsavel;
                if(!mapa[resp]) mapa[resp]=[];
                mapa[resp].push({nome:b.nome,meses:b.meses,justificativa:b.justificativa,atestado:b.atestado});
            });
            for(let chave in mapa){
                localStorage.setItem(chave,JSON.stringify(mapa[chave]));
            }
        } else {
            localStorage.setItem(coordenador,JSON.stringify(dados));
        }
    }

    renderTabela();
};
</script>
</body>
</html>
